"use strict";class jTDAL{constructor(t){this.selector="",this.document=$(t).clone().wrapAll("<tdal></tdal>").parent();for(let t=0,e=jTDAL.keywords.length;t<e;++t)this.selector+=(""===this.selector?"":",")+"[data-tdal-"+jTDAL.keywords[t]+"]"}static GetNearestChilds(t,e){let r=$();return t.children().each(function(){let t=$(this).filter(e);0<t.length&&(r=r.add($(this).filter(e))),0<(t=$(this).not(e)).length&&(r=r.add(jTDAL.GetNearestChilds(t,e)))}),r}static IsArray(t){return Array.isArray(t)||t===Object(t)&&"function"!=typeof t}static ExpressionResultToBoolean(t){let e=!0;return(void 0===t||null===t||!1===t||0===t||""===t||Array.isArray(t)&&0===t.length)&&(e=!1),e}static ParsePath(t,e,r){let a=void 0;const s=t.split("|"),o=s.length;for(let t=0;t<o;++t){const o=s[t].trim().split("/");switch(o[0]){case"REPEAT":3==o.length&&void 0!==r.REPEAT&&void 0!==r.REPEAT[o[1]]&&void 0!==r.REPEAT[o[1]][o[2]]&&(a=r.REPEAT[o[1]][o[2]]);break;case"NULL":case"FALSE":a=!1;break;case"DEFAULT":case"TRUE":a=!0;break;default:if(0<o.length){const t=o.length;a=r;for(let e=0;e<t;++e){if(void 0===a[o[e]]){a=void 0;break}a=a[o[e]]}if(void 0===a){a=e;for(let e=0;e<t;++e){if(void 0===a[o[e]]){a=void 0;break}a=a[o[e]]}}}}if(void 0!==a)break}return a}static ParseExpression(t,e,r){let a=void 0;const s=t.match(/^[\s]*(STRING:)?(.*)$/);if(s&&s[1]&&"STRING:"==s[1]){let t=s[2],o=null;for(;o=jTDAL.regexp.pathInString.exec(t);){let a=this.ParsePath(o[1],e,r);for(a&&1!=a||(a="");-1!==t.search(o[0]);)t=t.replace(o[0],a)}a=t}else a=jTDAL.ParsePath(t,e,r);return a}Parse(t,e,r={}){let a=!1,s=t.data("tdal-ignore"),o=!0;if(void 0!==s){t.removeData("tdal-ignore"),t.removeAttr("data-tdal-ignore");const n=s.match(jTDAL.regexp.condition);n&&(a=jTDAL.ExpressionResultToBoolean(jTDAL.ParseExpression(n[2],e,r)),"!"==n[1]&&(a=!o))}if(!a){if(void 0!==(s=t.data("tdal-condition"))){t.removeData("tdal-condition"),t.removeAttr("data-tdal-condition"),o=!0;const n=s.match(jTDAL.regexp.condition);n&&(o=jTDAL.ExpressionResultToBoolean(jTDAL.ParseExpression(n[2],e,r)),"!"==n[1]&&(o=!o),!1===o&&(t.remove(),a=!0))}if(!a){if(void 0!==(s=t.data("tdal-repeat"))){t.removeData("tdal-repeat"),t.removeAttr("data-tdal-repeat");const o=s.match(jTDAL.regexp.repeat);if(o){const s=jTDAL.ParseExpression(o[2],e,r);if(Array.isArray(s)){let a=Object.assign({},r);for(let r=0,n=s.length;r<n;++r){let i=t.clone();a[o[1]]=s[r],a.REPEAT[o[1]]={index:r,number:r+1,even:0==(r+1)%2,odd:1==(r+1)%2,start:0==r,end:n-1==r,length:n},this.Parse(i,e,a),t.before(i)}}t.remove(),a=!0}}if(!a){if(void 0!==(s=t.data("tdal-content"))){t.removeData("tdal-content"),t.removeAttr("data-tdal-content");let a=s.match(jTDAL.regexp.content);if(a){let s=jTDAL.ParseExpression(a[2],e,r);switch(a[1]){case"structure":void 0!==s&&!1!==s&&null!=s||(s=""),!0!==s&&t.html(s);break;case"text":void 0!==s&&!1!==s&&null!=s||(s=""),!0!==s&&t.text(s)}}}if(void 0!==(s=t.data("tdal-replace"))){t.removeData("tdal-content"),t.removeAttr("data-tdal-content");let a=s.match(jTDAL.regexp.content);if(a){let s=jTDAL.ParseExpression(a[2],e,r);switch(a[1]){case"structure":void 0!==s&&!1!==s&&null!=s||(s=""),!0!==s&&t.prop("outerHTML",s);break;case"text":void 0!==s&&!1!==s&&null!=s||(s=""),!0!==s&&t.prop("outerText",s)}}}if(void 0!==(s=t.data("tdal-attributes"))){t.removeData("tdal-attributes"),t.removeAttr("data-tdal-attributes");let a=null;for(;a=jTDAL.regexp.attributes.exec(s);){let s=jTDAL.ParseExpression(a[2],e,r);void 0===s||!1===s||null==s?t.removeAttr(a[1]):!0!==s&&t.attr(a[1],s)}}if(0<t.children().length){let a=jTDAL.GetNearestChilds(t,this.selector),s=a.length;for(let t=0;t<s;++t)this.Parse($(a[t]),e,r)}if(void 0!==(s=t.data("tdal-omittag"))){t.removeData("tdal-omittag"),t.removeAttr("data-tdal-omittag"),o=!0;const a=s.match(jTDAL.regexp.condition);a&&(o=jTDAL.ExpressionResultToBoolean(jTDAL.ParseExpression(a[2],e,r)),"!"==a[1]&&(o=!o),o&&t.contents().unwrap())}}}}}Render(t={}){let e=jTDAL.GetNearestChilds(this.document,this.selector),r=e.length;for(let a=0;a<r;++a)this.Parse($(e[a]),t,{REPEAT:{}});return this.document.children()}}jTDAL.regexpPatternPath="(?:[\\w-\\/]*[\\w](?:[\\s]*\\|[\\s]*[\\w-\\/]*[\\w])*)",jTDAL.regexpPatternExpression="("+jTDAL.regexpPatternPath+"|STRING:[^;]+)",jTDAL.regexp={condition:new RegExp("^[\\s]*(\\!?)[\\s]*("+jTDAL.regexpPatternPath+")[\\s]*$"),pathInString:new RegExp("{("+jTDAL.regexpPatternPath+")}"),repeat:new RegExp("^[\\s]*([\\w-]+?)[\\s]+"+jTDAL.regexpPatternExpression+"[\\s]*$"),content:new RegExp("^[\\s]*(?:(text|structure)[\\s]+)"+jTDAL.regexpPatternExpression+"[\\s]*$"),attributes:new RegExp("[\\s]*(?:(?:([\\w-]+?)[\\s]+"+jTDAL.regexpPatternExpression+"[\\s]*)(?:;[s]*|$))","gy")},jTDAL.keywords=["ignore","condition","repeat","content","replace","attributes","omittag"],jQuery.fn.extend({jTDAL:function(){return new jTDAL(this)}});